<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes | Admin Imperium</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --color-gold: #D4CDC1; --bg-card: #1e1e1e; }
        body { font-family: 'Montserrat', sans-serif; background-color: #000; color: #f8f9fa; }
        
        /* Layout */
        .sidebar { height: 100vh; background: var(--bg-card); border-right: 1px solid #333; position: fixed; left: 0; top: 0; width: 250px; padding: 20px; }
        .main-content { margin-left: 250px; padding: 30px; }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: relative; border-bottom: 1px solid #333; }
            .main-content { margin-left: 0; }
        }

        /* Estilos Específicos */
        .btn-whatsapp { 
            background: #25D366; color: #fff; border: none; 
            width: 35px; height: 35px; border-radius: 5px; 
            display: inline-flex; align-items: center; justify-content: center; 
            transition: 0.3s; text-decoration: none;
        }
        .btn-whatsapp:hover { opacity: 0.8; color: #fff; transform: scale(1.1); }
        
        .table-dark { --bs-table-bg: var(--bg-card); }
        h2 { font-family: 'Playfair Display', serif; color: var(--color-gold); }
        
        #loading { display: none; text-align: center; padding: 20px; color: var(--color-gold); }
    </style>
</head>
<body>

    <script>
        if (sessionStorage.getItem('imperium_admin') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>

    <div class="sidebar d-flex flex-column">
        <h3 class="mb-5 ps-2" style="color: var(--color-gold);">IMPERIUM <span style="font-size:0.8rem; display:block; color:#666; font-family:sans-serif;">Clientes</span></h3>
        <ul class="nav flex-column gap-2">
            <li class="nav-item"><a href="admin-agenda.html" class="nav-link text-secondary"><i class="bi bi-calendar-check me-2"></i> Agenda</a></li>
            
            <li class="nav-item"><a href="#" class="nav-link text-white active bg-secondary bg-opacity-25 rounded"><i class="bi bi-people me-2"></i> Clientes</a></li>
            
            <li class="nav-item"><a href="admin-financeiro.html" class="nav-link text-secondary"><i class="bi bi-cash-coin me-2"></i> Financeiro</a></li>
            
            <li class="nav-item mt-auto">
                <a href="login.html" onclick="sessionStorage.removeItem('imperium_admin'); window.location.href='login.html';" class="nav-link text-danger"><i class="bi bi-box-arrow-left me-2"></i> Sair</a>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Base de Clientes</h2>
            <div class="bg-dark p-2 rounded border border-secondary">
                <span class="text-white-50 small">Total Único: </span>
                <span class="text-white fw-bold" id="totalClientes">0</span>
            </div>
        </div>

        <div id="loading">
            <div class="spinner-border" role="status"></div>
            <p class="mt-2">Carregando base de dados...</p>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle">
                <thead>
                    <tr style="color: var(--color-gold);">
                        <th>Nome</th>
                        <th>Telefone</th>
                        <th class="text-center">Visitas</th>
                        <th class="text-center">Total Gasto</th>
                        <th class="text-center">Última Visita</th>
                        <th class="text-end">Ação</th>
                    </tr>
                </thead>
                <tbody id="tabelaClientes">
                    </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- ⚠️ COLE SUA CONFIGURAÇÃO AQUI (Não esqueça!) ⚠️ ---
        const firebaseConfig = {
    apiKey: "AIzaSyBFXGQC-uVRDvblURt1TXynXXDO554IqjI",
    authDomain: "imperium-7d616.firebaseapp.com",
    projectId: "imperium-7d616",
    storageBucket: "imperium-7d616.firebasestorage.app",
    messagingSenderId: "142571674206",
    appId: "1:142571674206:web:f216f7984d8cdb065672cf"
  };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function carregarClientes() {
            const loadingDiv = document.getElementById('loading');
            const tbody = document.getElementById('tabelaClientes');
            
            loadingDiv.style.display = 'block'; // Mostra carregando

            try {
                // Busca TODOS os agendamentos
                const q = query(collection(db, "agendamentos"));
                const snapshot = await getDocs(q);
                
                const clientesMap = new Map();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Ignora se não tiver telefone (dados sujos/antigos)
                    if(!data.telefone || !data.nome) return;

                    // Limpa o telefone para usar como ID único
                    const telLimpo = data.telefone.replace(/\D/g, ''); 
                    if(telLimpo === "") return;

                    // Se é novo na lista, cria o cadastro
                    if (!clientesMap.has(telLimpo)) {
                        clientesMap.set(telLimpo, {
                            nome: data.nome,
                            telefone: data.telefone,
                            visitas: 0,
                            gastoTotal: 0,
                            ultimaDataISO: '1970-01-01',
                            ultimaDataTexto: '---'
                        });
                    }

                    // Atualiza os dados
                    const cliente = clientesMap.get(telLimpo);
                    cliente.visitas++;
                    cliente.gastoTotal += Number(data.valor) || 0;

                    // Verifica se é a data mais recente
                    if(data.dataHora > cliente.ultimaDataISO) {
                        cliente.ultimaDataISO = data.dataHora;
                        cliente.ultimaDataTexto = data.dataHoraTexto;
                    }
                });

                // Limpa e Renderiza
                tbody.innerHTML = '';
                document.getElementById('totalClientes').innerText = clientesMap.size;
                
                if (clientesMap.size === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Nenhum cliente encontrado.</td></tr>';
                }

                clientesMap.forEach((info, tel) => {
                    // Pega apenas a data (remove a hora para caber melhor)
                    const dataCurta = info.ultimaDataTexto.split(' às')[0] || info.ultimaDataTexto;

                    const row = `
                        <tr>
                            <td class="fw-bold text-white">${info.nome}</td>
                            <td class="text-secondary">${info.telefone}</td>
                            <td class="text-center"><span class="badge bg-secondary">${info.visitas}</span></td>
                            <td class="text-center text-success">R$ ${info.gastoTotal},00</td>
                            <td class="text-center small text-white-50">${dataCurta}</td>
                            <td class="text-end">
                                <a href="https://wa.me/55${tel}" target="_blank" class="btn-whatsapp" title="Conversar no WhatsApp">
                                    <i class="bi bi-whatsapp"></i>
                                </a>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (error) {
                console.error("Erro:", error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">Erro ao carregar. Veja o console (F12).</td></tr>`;
            } finally {
                loadingDiv.style.display = 'none'; // Esconde carregando
            }
        }

        // Inicia
        carregarClientes();
    </script>
</body>
</html>