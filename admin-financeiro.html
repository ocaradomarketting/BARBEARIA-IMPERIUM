<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro | Admin Imperium</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --color-gold: #D4CDC1; --bg-card: #1e1e1e; }
        body { font-family: 'Montserrat', sans-serif; background-color: #000; color: #f8f9fa; }
        .sidebar { height: 100vh; background: var(--bg-card); border-right: 1px solid #333; position: fixed; left: 0; top: 0; width: 250px; padding: 20px; }
        .main-content { margin-left: 250px; padding: 30px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: 8px; border: 1px solid #333; }
        .stat-number { font-size: 2rem; font-weight: bold; color: var(--color-gold); }
        h2 { font-family: 'Playfair Display', serif; color: var(--color-gold); }
    </style>
</head>
<body>

    <script>
        if (sessionStorage.getItem('imperium_admin') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>

    <div class="sidebar d-flex flex-column">
        <h3 class="mb-5 ps-2" style="color: var(--color-gold);">IMPERIUM <span style="font-size:0.8rem; display:block; color:#666; font-family:sans-serif;">Financeiro</span></h3>
        <ul class="nav flex-column gap-2">
            <li class="nav-item"><a href="admin-agenda.html" class="nav-link text-secondary"><i class="bi bi-calendar-check me-2"></i> Agenda</a></li>
            <li class="nav-item"><a href="admin-clientes.html" class="nav-link text-secondary"><i class="bi bi-people me-2"></i> Clientes</a></li>
            <li class="nav-item"><a href="admin-financeiro.html" class="nav-link text-white active bg-secondary bg-opacity-25 rounded"><i class="bi bi-cash-coin me-2"></i> Financeiro</a></li>
            <li class="nav-item mt-auto">
                <a href="login.html" onclick="sessionStorage.removeItem('imperium_admin'); window.location.href='login.html';" class="nav-link text-danger"><i class="bi bi-box-arrow-left me-2"></i> Sair</a>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Painel Financeiro</h2>
            <button class="btn btn-outline-light btn-sm" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="stat-card">
                    <span class="text-secondary small text-uppercase">Faturamento Total</span>
                    <div class="stat-number mt-2" id="fatTotal">R$ 0</div>
                    <small class="text-white-50">Apenas Confirmados</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <span class="text-secondary small text-uppercase">Ticket Médio</span>
                    <div class="stat-number mt-2" id="ticketMedio">R$ 0</div>
                    <small class="text-white-50">Média por corte</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <span class="text-secondary small text-uppercase">Serviço + Vendido</span>
                    <div class="stat-number mt-2" id="topServico" style="font-size: 1.5rem;">...</div>
                    <small class="text-white-50">Favorito dos clientes</small>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-secondary">
            <div class="card-body">
                <h5 class="card-title text-white mb-4">Entradas por Mês (2025)</h5>
                <div style="height: 300px;">
                    <canvas id="graficoFinanceiro"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- ⚠️ COLE SUA CONFIGURAÇÃO AQUI ⚠️ ---
         const firebaseConfig = {
    apiKey: "AIzaSyBFXGQC-uVRDvblURt1TXynXXDO554IqjI",
    authDomain: "imperium-7d616.firebaseapp.com",
    projectId: "imperium-7d616",
    storageBucket: "imperium-7d616.firebasestorage.app",
    messagingSenderId: "142571674206",
    appId: "1:142571674206:web:f216f7984d8cdb065672cf"
  };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function carregarFinanceiro() {
            // Busca apenas agendamentos CONFIRMADOS (dinheiro real)
            const q = query(collection(db, "agendamentos"), where("status", "==", "confirmado"));
            const snapshot = await getDocs(q);

            let total = 0;
            let count = 0;
            const servicosCount = {};
            
            // Dados para o Gráfico (12 meses)
            const dadosGrafico = new Array(12).fill(0); 

            snapshot.forEach(doc => {
                const data = doc.data();
                const valor = Number(data.valor) || 0;
                
                // 1. Soma Total
                total += valor;
                count++;

                // 2. Contagem de Serviços (para descobrir o top)
                if(data.servico) {
                    servicosCount[data.servico] = (servicosCount[data.servico] || 0) + 1;
                }

                // 3. Preenche Gráfico pelo Mês
                try {
                    const dataObj = new Date(data.dataHora);
                    const mesIndex = dataObj.getMonth(); // 0 = Jan, 11 = Dez
                    if (!isNaN(mesIndex)) {
                        dadosGrafico[mesIndex] += valor;
                    }
                } catch (e) { console.warn("Data inválida ignorada"); }
            });

            // --- ATUALIZA TELA ---
            document.getElementById('fatTotal').innerText = `R$ ${total},00`;
            
            const media = count > 0 ? (total / count).toFixed(2) : "0.00";
            document.getElementById('ticketMedio').innerText = `R$ ${media}`;

            // Descobre serviço mais vendido
            let melhorServico = "-";
            let maxVendas = 0;
            for (const [nome, qtd] of Object.entries(servicosCount)) {
                if (qtd > maxVendas) {
                    maxVendas = qtd;
                    melhorServico = nome;
                }
            }
            // Abrevia o nome se for muito longo
            if(melhorServico.length > 15) melhorServico = melhorServico.substring(0, 15) + "...";
            document.getElementById('topServico').innerText = melhorServico;

            // --- GERA O GRÁFICO (Chart.js) ---
            new Chart(document.getElementById('graficoFinanceiro'), {
                type: 'bar',
                data: {
                    labels: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
                    datasets: [{
                        label: 'Faturamento (R$)',
                        data: dadosGrafico,
                        backgroundColor: '#D4CDC1',
                        borderColor: '#D4CDC1',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false } // Esconde legenda para ficar clean
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#333' },
                            ticks: { color: '#888' } 
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#888' } 
                        }
                    }
                }
            });
        }

        carregarFinanceiro();
    </script>
</body>
</html>